<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta ‚Äî Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     ¬© 2025. No comercial, atribuci√≥n y consulta previa. TAL CUAL, sin garant√≠as.
     Ver LICENSE para t√©rminos completos.
-->

<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8">
  <title>Upload Series Episodes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dropzone {
      border: 2px dashed #9333ea;
      transition: all 0.3s ease;
    }
    .dropzone.dragover {
      border-color: #a855f7;
      background-color: rgba(147, 51, 234, 0.1);
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #1f2937;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    .file-item .parsed {
      color: #a855f7;
      font-size: 0.75rem;
    }
    .file-item .warning {
      color: #f59e0b;
    }
    .file-item .progress-bar {
      width: 40px;
      height: 8px;
      background: #374151;
      border-radius: 4px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .file-item .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #9333ea, #a855f7);
      width: 0%;
      transition: width 0.2s ease;
    }
    .file-item .progress-fill.complete {
      background: linear-gradient(90deg, #22c55e, #4ade80);
    }
    .file-item .progress-fill.error {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }
    .file-item.uploading {
      opacity: 0.8;
    }
    .file-item.complete {
      opacity: 0.6;
    }
    .file-item .status-icon {
      width: 16px;
      text-align: center;
      flex-shrink: 0;
    }
  </style>
</head>
<body class="bg-black text-white font-mono min-h-screen p-4">
  <div class="max-w-2xl mx-auto">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <h1 class="text-2xl sm:text-3xl text-purple-400 font-bold">
        Upload Series Episodes
      </h1>

      <div class="flex items-center gap-4">
        <a href="{{ url_for('series_page') }}"
           class="text-blue-400 hover:underline text-sm sm:text-base whitespace-nowrap">
          Back to Series
        </a>
      </div>
    </header>

    <form action="{{ url_for('upload_series') }}" method="post" enctype="multipart/form-data" id="upload-form">
      <!-- Series Selection -->
      <div class="bg-gray-800 border border-purple-600 rounded-lg p-6 mb-6">
        <h2 class="text-lg font-bold text-purple-300 mb-4">Select Series</h2>

        {% if series_list %}
        <div class="mb-4">
          <label class="block text-sm mb-2 text-gray-300">Choose existing series:</label>
          <select name="series" id="series-select"
                  class="w-full bg-gray-900 text-white px-3 py-2 rounded border border-gray-600 focus:border-purple-500 focus:outline-none">
            <option value="">-- Select a series --</option>
            {% for series in series_list %}
            <option value="{{ series.folder_name }}" {% if series.folder_name == preselected %}selected{% endif %}>
              {{ series.display_name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="text-center text-gray-500 mb-4">‚Äî OR ‚Äî</div>
        {% endif %}

        <div>
          <label class="block text-sm mb-2 text-gray-300">Create new series:</label>
          <input type="text" name="new_series" id="new-series-input"
                 placeholder="e.g. Los Simuladores"
                 class="w-full bg-gray-900 text-white px-3 py-2 rounded border border-gray-600 focus:border-purple-500 focus:outline-none">
          <p class="text-xs text-gray-500 mt-1">Leave empty to use selected series above.</p>
        </div>
      </div>

      <!-- File Upload -->
      <div class="bg-gray-800 border border-purple-600 rounded-lg p-6 mb-6">
        <h2 class="text-lg font-bold text-purple-300 mb-4">Upload Episodes</h2>

        <div id="dropzone" class="dropzone rounded-lg p-8 text-center cursor-pointer mb-4">
          <input type="file" name="videos[]" id="file-input" multiple accept=".mp4" class="hidden">
          <div class="text-4xl mb-2">üì∫</div>
          <p class="text-gray-300 mb-2">Drag & drop episode files here</p>
          <p class="text-sm text-gray-500">or click to browse</p>
          <p class="text-xs text-gray-600 mt-2">Supported formats: S01E05.mp4, 1x05.mp4, Season1Episode5.mp4</p>
        </div>

        <div id="file-list" class="hidden">
          <h3 class="text-sm font-bold text-gray-300 mb-2">Files to upload:</h3>
          <div id="file-items"></div>
        </div>
      </div>

      <!-- Submit -->
      <div class="flex justify-between items-center">
        <a href="{{ url_for('series_page') }}" id="cancel-link" class="text-blue-400 hover:underline text-sm">Cancel</a>
        <button type="button" id="submit-btn" disabled
                class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold px-6 py-2 rounded shadow">
          Upload Episodes
        </button>
      </div>

      <!-- Upload status message -->
      <div id="upload-status" class="hidden mt-4 text-center text-sm"></div>
    </form>
  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const fileItems = document.getElementById('file-items');
    const submitBtn = document.getElementById('submit-btn');
    const seriesSelect = document.getElementById('series-select');
    const newSeriesInput = document.getElementById('new-series-input');
    const uploadStatus = document.getElementById('upload-status');
    const cancelLink = document.getElementById('cancel-link');

    let isUploading = false;
    let fileElements = new Map(); // Map file name -> DOM element

    // Episode parsing patterns
    const patterns = [
      /[Ss](\d+)[Ee](\d+)/,           // S01E05
      /(\d+)[xX](\d+)/,                // 1x05
      /[Ss]eason\s*(\d+)\s*[Ee]pisode\s*(\d+)/i  // Season 1 Episode 5
    ];

    function parseEpisode(filename) {
      for (const pattern of patterns) {
        const match = filename.match(pattern);
        if (match) {
          return { season: parseInt(match[1]), episode: parseInt(match[2]) };
        }
      }
      return null;
    }

    function updateFileList() {
      const files = fileInput.files;
      fileItems.innerHTML = '';
      fileElements.clear();

      if (files.length === 0) {
        fileList.classList.add('hidden');
        submitBtn.disabled = true;
        return;
      }

      fileList.classList.remove('hidden');

      for (const file of files) {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.dataset.filename = file.name;

        const parsed = parseEpisode(file.name);
        let parsedText = '';
        if (parsed) {
          parsedText = `<span class="parsed">‚Üí S${parsed.season}E${parsed.episode}</span>`;
        } else {
          parsedText = `<span class="parsed warning">‚ö†Ô∏è No S/E</span>`;
        }

        item.innerHTML = `
          <span class="status-icon"></span>
          <div class="progress-bar"><div class="progress-fill"></div></div>
          <span class="flex-1 truncate text-sm">${file.name}</span>
          ${parsedText}
        `;
        fileItems.appendChild(item);
        fileElements.set(file.name, item);
      }

      updateSubmitButton();
    }

    function updateFileProgress(filename, percent, status = 'uploading') {
      const item = fileElements.get(filename);
      if (!item) return;

      const fill = item.querySelector('.progress-fill');
      const icon = item.querySelector('.status-icon');

      fill.style.width = `${percent}%`;
      item.classList.remove('uploading', 'complete');

      if (status === 'complete') {
        fill.classList.add('complete');
        fill.classList.remove('error');
        item.classList.add('complete');
        icon.textContent = '‚úì';
        icon.style.color = '#22c55e';
      } else if (status === 'error') {
        fill.classList.add('error');
        fill.classList.remove('complete');
        icon.textContent = '‚úó';
        icon.style.color = '#ef4444';
      } else {
        fill.classList.remove('complete', 'error');
        item.classList.add('uploading');
        icon.textContent = '';
      }
    }

    function updateSubmitButton() {
      if (isUploading) {
        submitBtn.disabled = true;
        return;
      }
      const hasFiles = fileInput.files.length > 0;
      const hasSeries = (seriesSelect && seriesSelect.value) || newSeriesInput.value.trim();
      submitBtn.disabled = !(hasFiles && hasSeries);
    }

    function setUploadingState(uploading) {
      isUploading = uploading;
      submitBtn.disabled = uploading;
      submitBtn.textContent = uploading ? 'Uploading...' : 'Upload Episodes';
      dropzone.style.pointerEvents = uploading ? 'none' : 'auto';
      dropzone.style.opacity = uploading ? '0.5' : '1';
      if (seriesSelect) seriesSelect.disabled = uploading;
      newSeriesInput.disabled = uploading;
      cancelLink.style.pointerEvents = uploading ? 'none' : 'auto';
      cancelLink.style.opacity = uploading ? '0.5' : '1';
    }

    function showStatus(message, type = 'info') {
      uploadStatus.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-yellow-400', 'text-gray-400');
      if (type === 'success') uploadStatus.classList.add('text-green-400');
      else if (type === 'error') uploadStatus.classList.add('text-red-400');
      else if (type === 'warning') uploadStatus.classList.add('text-yellow-400');
      else uploadStatus.classList.add('text-gray-400');
      uploadStatus.textContent = message;
    }

    async function uploadFiles() {
      const files = Array.from(fileInput.files);
      if (files.length === 0) return;

      const series = seriesSelect?.value || '';
      const newSeries = newSeriesInput.value.trim();

      if (!series && !newSeries) {
        showStatus('Please select or create a series first.', 'error');
        return;
      }

      setUploadingState(true);
      showStatus(`Uploading 0 of ${files.length} files...`, 'info');

      let completed = 0;
      let errors = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        showStatus(`Uploading ${i + 1} of ${files.length}: ${file.name}`, 'info');

        try {
          await uploadSingleFile(file, series, newSeries);
          completed++;
          updateFileProgress(file.name, 100, 'complete');
        } catch (err) {
          errors++;
          updateFileProgress(file.name, 100, 'error');
          console.error(`Failed to upload ${file.name}:`, err);
        }
      }

      setUploadingState(false);

      if (errors === 0) {
        showStatus(`All ${completed} file(s) uploaded successfully! Redirecting...`, 'success');
        setTimeout(() => {
          window.location.href = "{{ url_for('series_page') }}";
        }, 1500);
      } else {
        showStatus(`Completed: ${completed} succeeded, ${errors} failed.`, errors > 0 ? 'warning' : 'success');
      }
    }

    function uploadSingleFile(file, series, newSeries) {
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('videos[]', file);
        formData.append('series', series);
        formData.append('new_series', newSeries);

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            updateFileProgress(file.name, percent, 'uploading');
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            resolve();
          } else {
            reject(new Error(`HTTP ${xhr.status}`));
          }
        });

        xhr.addEventListener('error', () => reject(new Error('Network error')));
        xhr.addEventListener('abort', () => reject(new Error('Aborted')));

        xhr.open('POST', "{{ url_for('upload_series_post') }}");
        xhr.send(formData);
      });
    }

    // Submit button click
    submitBtn.addEventListener('click', uploadFiles);

    // Dropzone events
    dropzone.addEventListener('click', () => {
      if (!isUploading) fileInput.click();
    });

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (!isUploading) dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      if (isUploading) return;

      const dt = new DataTransfer();
      for (const file of e.dataTransfer.files) {
        if (file.name.toLowerCase().endsWith('.mp4')) {
          dt.items.add(file);
        }
      }
      fileInput.files = dt.files;
      updateFileList();
    });

    fileInput.addEventListener('change', updateFileList);

    if (seriesSelect) {
      seriesSelect.addEventListener('change', () => {
        if (seriesSelect.value) {
          newSeriesInput.value = '';
        }
        updateSubmitButton();
      });
    }

    newSeriesInput.addEventListener('input', () => {
      if (newSeriesInput.value.trim() && seriesSelect) {
        seriesSelect.value = '';
      }
      updateSubmitButton();
    });

    // Initial state
    updateSubmitButton();
  </script>
</body>
</html>
