<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta â€” Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     Â© 2025. No comercial, atribuciÃ³n y consulta previa. TAL CUAL, sin garantÃ­as.
     Ver LICENSE para tÃ©rminos completos.
-->
{% extends "base.html" %}

{% block title %}Content Manager - TVArgenta{% endblock %}

{% block extra_styles %}
  .section-card {
    background: rgba(17,24,39,.6);
    backdrop-filter: blur(2px);
  }
  .section-header {
    cursor: pointer;
    user-select: none;
  }
  .section-header:hover {
    background: rgba(255,255,255,0.05);
  }
  .dropzone {
    border: 2px dashed #4b5563;
    transition: all 0.3s ease;
  }
  .dropzone.dragover {
    border-color: #a855f7;
    background-color: rgba(147, 51, 234, 0.1);
  }
  .file-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: #1f2937;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
  }
  .file-item .progress-bar {
    width: 40px;
    height: 8px;
    background: #374151;
    border-radius: 4px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .file-item .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #9333ea, #a855f7);
    width: 0%;
    transition: width 0.2s ease;
  }
  .file-item .progress-fill.complete {
    background: linear-gradient(90deg, #22c55e, #4ade80);
  }
  .content-card {
    background: rgba(17,24,39,0.8);
    border: 1px solid #374151;
    transition: border-color 0.2s;
  }
  .content-card:hover {
    border-color: #9333ea;
  }
  .tape-card:hover {
    border-color: #facc15;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 200, 0, 0.2);
  }
  .scanning { animation: pulse 1.5s ease-in-out infinite; }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
{% endblock %}

{% block content %}
  <h1 class="text-2xl sm:text-3xl text-yellow-400 font-bold text-center mb-6">Content Manager</h1>

  <!-- ============================================ -->
  <!-- VCR TAPES SECTION (Prominent) -->
  <!-- ============================================ -->
  <section class="section-card rounded-lg border border-yellow-600 mb-6 overflow-hidden">
    <div class="section-header flex items-center justify-between p-4 bg-yellow-900/30" onclick="toggleSection('vcr')">
      <div class="flex items-center gap-3">
        <span class="text-3xl">ðŸ“¼</span>
        <div>
          <h2 class="text-xl font-bold text-yellow-400">VCR Tapes</h2>
          <p class="text-sm text-gray-400">NFC tape management</p>
        </div>
      </div>
      <span id="vcr-toggle" class="text-2xl text-gray-400">â–¼</span>
    </div>

    <div id="vcr-content" class="p-4">
      <!-- NFC Reader Status -->
      <div id="reader-status" class="mb-4 p-3 rounded-lg border-2 border-gray-600 bg-gray-900/50">
        <div class="flex items-center gap-3">
          <span id="reader-icon" class="text-2xl">ðŸ”Œ</span>
          <div>
            <div id="reader-text" class="font-bold text-sm">Checking NFC Reader...</div>
            <div id="reader-detail" class="text-xs text-gray-400"></div>
          </div>
        </div>
      </div>

      <!-- Register New Tape -->
      <div id="scan-section" class="mb-4 p-4 bg-gray-900/50 rounded-lg border border-blue-600">
        <h3 class="text-lg font-bold text-blue-400 mb-3">Register New Tape</h3>
        <p class="text-sm text-gray-300 mb-3">Place an unregistered mini VHS tape on the NFC reader.</p>

        <div id="scan-waiting" class="hidden">
          <div class="flex items-center gap-3 text-yellow-400 scanning">
            <span class="text-xl">ðŸ“¡</span>
            <span class="text-sm">Waiting for tape...</span>
          </div>
        </div>

        <div id="scan-detected" class="hidden">
          <div class="bg-green-900/50 border border-green-500 rounded p-3 mb-3">
            <div class="flex items-center gap-2 text-green-400 font-bold text-sm mb-1">
              <span>âœ“</span> New Tape Detected!
            </div>
            <div class="text-xs">
              <span class="text-gray-400">UID:</span>
              <span id="detected-uid" class="font-mono text-white"></span>
            </div>
          </div>

          <form id="register-form" class="space-y-3">
            <input type="hidden" id="register-uid" name="uid">
            <div>
              <label class="block text-xs mb-1 text-gray-300">Select Video:</label>
              <select id="register-video" name="video_id" required
                      class="w-full bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 text-sm">
                <option value="">-- Select a video --</option>
              </select>
            </div>
            <div>
              <label class="block text-xs mb-1 text-gray-300">Custom Title (optional):</label>
              <input type="text" id="register-title" name="title"
                     placeholder="Leave blank to use video title"
                     class="w-full bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 text-sm">
            </div>
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
              Register Tape
            </button>
          </form>
        </div>
      </div>

      <!-- Registered Tapes List -->
      <h3 class="text-lg font-bold text-yellow-400 mb-3">Registered Tapes</h3>
      <div id="tapes-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="text-gray-500 italic text-sm">Loading tapes...</div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- TV SERIES SECTION -->
  <!-- ============================================ -->
  <section class="section-card rounded-lg border border-purple-600 mb-6 overflow-hidden">
    <div class="section-header flex items-center justify-between p-4 bg-purple-900/30" onclick="toggleSection('series')">
      <div class="flex items-center gap-3">
        <span class="text-3xl">ðŸ“º</span>
        <div>
          <h2 class="text-xl font-bold text-purple-400">TV Series</h2>
          <p class="text-sm text-gray-400"><span id="series-count">0</span> series</p>
        </div>
      </div>
      <span id="series-toggle" class="text-2xl text-gray-400">â–¼</span>
    </div>

    <div id="series-content" class="p-4">
      <!-- Upload Episodes -->
      <div class="mb-6 p-4 bg-gray-900/50 rounded-lg border border-purple-500">
        <h3 class="text-lg font-bold text-purple-300 mb-3">Upload Episodes</h3>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-xs mb-1 text-gray-300">Select Series:</label>
            <select id="series-select" class="w-full bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 text-sm">
              <option value="">-- Select series --</option>
            </select>
          </div>
          <div>
            <label class="block text-xs mb-1 text-gray-300">Or Create New:</label>
            <input type="text" id="new-series-input" placeholder="e.g. Los Simuladores"
                   class="w-full bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 text-sm">
          </div>
        </div>

        <div id="series-dropzone" class="dropzone rounded-lg p-6 text-center cursor-pointer mb-3">
          <input type="file" id="series-file-input" multiple accept=".mp4" class="hidden">
          <div class="text-3xl mb-2">ðŸ“º</div>
          <p class="text-gray-300 text-sm mb-1">Drag & drop episode files here</p>
          <p class="text-xs text-gray-500">Formats: S01E05.mp4, 1x05.mp4</p>
        </div>

        <div id="series-file-list" class="hidden mb-3">
          <div id="series-file-items"></div>
        </div>

        <div class="flex justify-end">
          <button id="series-upload-btn" disabled
                  class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold px-4 py-2 rounded text-sm">
            Upload Episodes
          </button>
        </div>
        <div id="series-upload-status" class="hidden mt-2 text-center text-sm"></div>
      </div>

      <!-- Series List -->
      <h3 class="text-lg font-bold text-purple-400 mb-3">Your Series</h3>
      <div id="series-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="text-gray-500 italic text-sm">Loading series...</div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- COMMERCIALS SECTION -->
  <!-- ============================================ -->
  <section class="section-card rounded-lg border border-green-600 mb-6 overflow-hidden">
    <div class="section-header flex items-center justify-between p-4 bg-green-900/30" onclick="toggleSection('commercials')">
      <div class="flex items-center gap-3">
        <span class="text-3xl">ðŸ“¢</span>
        <div>
          <h2 class="text-xl font-bold text-green-400">Commercials</h2>
          <p class="text-sm text-gray-400"><span id="commercials-count">0</span> commercials</p>
        </div>
      </div>
      <span id="commercials-toggle" class="text-2xl text-gray-400">â–¼</span>
    </div>

    <div id="commercials-content" class="p-4">
      <!-- Upload Commercials -->
      <div class="mb-6 p-4 bg-gray-900/50 rounded-lg border border-green-500">
        <h3 class="text-lg font-bold text-green-300 mb-3">Upload Commercials</h3>

        <div id="commercials-dropzone" class="dropzone rounded-lg p-6 text-center cursor-pointer mb-3">
          <input type="file" id="commercials-file-input" multiple accept=".mp4" class="hidden">
          <div class="text-3xl mb-2">ðŸ“¢</div>
          <p class="text-gray-300 text-sm mb-1">Drag & drop commercial files here</p>
          <p class="text-xs text-gray-500">H.264 encoded .mp4 files</p>
        </div>

        <div id="commercials-file-list" class="hidden mb-3">
          <div id="commercials-file-items"></div>
        </div>

        <div class="flex justify-end">
          <button id="commercials-upload-btn" disabled
                  class="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold px-4 py-2 rounded text-sm">
            Upload Commercials
          </button>
        </div>
        <div id="commercials-upload-status" class="hidden mt-2 text-center text-sm"></div>
      </div>

      <!-- Commercials List -->
      <h3 class="text-lg font-bold text-green-400 mb-3">Your Commercials</h3>
      <div id="commercials-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <div class="text-gray-500 italic text-sm">Loading commercials...</div>
      </div>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  // ============================================
  // SECTION TOGGLE
  // ============================================
  function toggleSection(section) {
    const content = document.getElementById(section + '-content');
    const toggle = document.getElementById(section + '-toggle');
    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    toggle.textContent = isHidden ? 'â–¼' : 'â–¶';
    localStorage.setItem('section_' + section, isHidden ? 'open' : 'closed');
  }

  // Restore section states
  ['vcr', 'series', 'commercials'].forEach(section => {
    const state = localStorage.getItem('section_' + section);
    if (state === 'closed') {
      document.getElementById(section + '-content').style.display = 'none';
      document.getElementById(section + '-toggle').textContent = 'â–¶';
    }
  });

  // ============================================
  // HELPERS
  // ============================================
  function formatDuration(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  }

  function sanitizeFilename(filename) {
    const basename = filename.split(/[/\\]/).pop();
    const noExt = basename.replace(/\.[^.]+$/, '');
    return noExt.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '_');
  }

  // ============================================
  // VCR TAPES
  // ============================================
  let vcrVideos = [];

  async function loadVcrVideos() {
    try {
      const res = await fetch('/api/vcr/videos');
      const data = await res.json();
      if (data.ok) {
        vcrVideos = data.videos || [];
        const select = document.getElementById('register-video');
        select.innerHTML = '<option value="">-- Select a video --</option>';
        vcrVideos.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.video_id;
          opt.textContent = `${v.title} (${formatDuration(v.duration)})`;
          select.appendChild(opt);
        });
      }
    } catch (e) { console.error('Failed to load VCR videos:', e); }
  }

  async function loadTapes() {
    try {
      const res = await fetch('/api/vcr/tapes');
      const data = await res.json();
      const container = document.getElementById('tapes-list');

      if (!data.ok || !data.tapes || data.tapes.length === 0) {
        container.innerHTML = '<div class="text-gray-500 italic text-sm col-span-2">No tapes registered. Scan a tape to register it.</div>';
        return;
      }

      container.innerHTML = data.tapes.map(tape => `
        <div class="tape-card content-card rounded-lg p-3 transition-all">
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-xl">ðŸ“¼</span>
              <h4 class="font-bold text-white text-sm">${tape.title || tape.video_id}</h4>
            </div>
          </div>
          <div class="text-xs text-gray-400 mb-1 font-mono">${tape.uid}</div>
          <div class="text-xs text-gray-300 mb-2">
            <span class="text-yellow-400">Video:</span> ${tape.video_title || tape.video_id}
          </div>
          <div class="text-xs text-gray-300 mb-2">
            <span class="text-blue-400">Position:</span> ${formatDuration(tape.position_sec || 0)}
          </div>
          <div class="flex justify-end gap-3">
            <button onclick="deleteTape('${tape.uid}')" class="text-red-400 hover:underline text-xs">Delete</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      document.getElementById('tapes-list').innerHTML = '<div class="text-red-400 text-sm">Error loading tapes</div>';
    }
  }

  async function updateReaderStatus() {
    try {
      const res = await fetch('/api/vcr/state');
      const data = await res.json();

      const statusEl = document.getElementById('reader-status');
      const iconEl = document.getElementById('reader-icon');
      const textEl = document.getElementById('reader-text');
      const detailEl = document.getElementById('reader-detail');

      if (!data.ok) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-red-600 bg-red-900/30';
        iconEl.textContent = 'âŒ';
        textEl.textContent = 'Error';
        detailEl.textContent = data.error || 'Unknown error';
        return;
      }

      if (!data.reader_attached) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-gray-600 bg-gray-900/50';
        iconEl.textContent = 'ðŸ”Œ';
        textEl.textContent = 'NFC Reader Not Detected';
        detailEl.textContent = 'Connect your USB NFC reader';
        document.getElementById('scan-waiting').classList.add('hidden');
        document.getElementById('scan-detected').classList.add('hidden');
      } else if (data.tape_inserted) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-green-600 bg-green-900/30';
        iconEl.textContent = 'ðŸ“¼';
        textEl.textContent = 'Tape Inserted';
        detailEl.textContent = `Playing: ${data.title || data.video_id}`;
        document.getElementById('scan-waiting').classList.add('hidden');
        document.getElementById('scan-detected').classList.add('hidden');
      } else if (data.unknown_tape_uid) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-yellow-600 bg-yellow-900/30';
        iconEl.textContent = 'â“';
        textEl.textContent = 'Unregistered Tape Detected';
        detailEl.textContent = 'Register it below';
        document.getElementById('scan-waiting').classList.add('hidden');
        document.getElementById('scan-detected').classList.remove('hidden');
        document.getElementById('detected-uid').textContent = data.unknown_tape_uid;
        document.getElementById('register-uid').value = data.unknown_tape_uid;
      } else {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-blue-600 bg-blue-900/30';
        iconEl.textContent = 'ðŸ“¡';
        textEl.textContent = 'NFC Reader Ready';
        detailEl.textContent = 'Place a tape on the reader';
        document.getElementById('scan-waiting').classList.remove('hidden');
        document.getElementById('scan-detected').classList.add('hidden');
      }
    } catch (e) { console.error('Failed to get VCR state:', e); }
  }

  document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const uid = document.getElementById('register-uid').value;
    const videoId = document.getElementById('register-video').value;
    const title = document.getElementById('register-title').value;

    if (!uid || !videoId) { alert('Please select a video'); return; }

    try {
      const res = await fetch('/api/vcr/tapes/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid, video_id: videoId, title: title || null })
      });
      const data = await res.json();
      if (data.ok) {
        alert('Tape registered!');
        document.getElementById('register-form').reset();
        loadTapes();
        updateReaderStatus();
      } else {
        alert('Error: ' + (data.error || 'Unknown'));
      }
    } catch (e) { alert('Failed to register tape'); }
  });

  async function deleteTape(uid) {
    if (!confirm('Delete this tape mapping?')) return;
    try {
      const res = await fetch(`/api/vcr/tapes/${encodeURIComponent(uid)}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.ok) loadTapes();
      else alert('Error: ' + (data.error || 'Unknown'));
    } catch (e) { alert('Failed to delete tape'); }
  }

  // ============================================
  // TV SERIES
  // ============================================
  const seriesExistingIds = new Set({{ series_existing_ids | default([]) | tojson }});
  let seriesFiles = [];

  async function loadSeries() {
    try {
      const res = await fetch('/api/series');
      const data = await res.json();
      const container = document.getElementById('series-list');
      const select = document.getElementById('series-select');

      if (!data.ok || !data.series || data.series.length === 0) {
        container.innerHTML = '<div class="text-gray-500 italic text-sm col-span-2">No series yet. Create one above.</div>';
        select.innerHTML = '<option value="">-- Select series --</option>';
        document.getElementById('series-count').textContent = '0';
        return;
      }

      document.getElementById('series-count').textContent = data.series.length;

      // Update dropdown
      select.innerHTML = '<option value="">-- Select series --</option>';
      data.series.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.folder_name;
        opt.textContent = s.display_name;
        select.appendChild(opt);
      });

      // Render cards
      container.innerHTML = data.series.map(s => `
        <div class="content-card rounded-lg p-3">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xl">ðŸ“º</span>
            <h4 class="font-bold text-white text-sm">${s.display_name}</h4>
          </div>
          <p class="text-xs text-gray-300 mb-2">
            <span class="text-purple-300 font-semibold">${s.episode_count}</span> episode${s.episode_count !== 1 ? 's' : ''}
          </p>
          <div class="mb-2">
            <label class="block text-xs text-gray-400 mb-1">Broadcast Time</label>
            <select class="time-select w-full bg-gray-800 text-white px-2 py-1 rounded border border-gray-600 text-xs"
                    data-series="${s.folder_name}">
              <option value="any" ${s.time_of_day === 'any' ? 'selected' : ''}>Any Time</option>
              <option value="early_morning" ${s.time_of_day === 'early_morning' ? 'selected' : ''}>Early Morning (4-7am)</option>
              <option value="late_morning" ${s.time_of_day === 'late_morning' ? 'selected' : ''}>Late Morning (7am-12pm)</option>
              <option value="afternoon" ${s.time_of_day === 'afternoon' ? 'selected' : ''}>Afternoon (12-5pm)</option>
              <option value="evening" ${s.time_of_day === 'evening' ? 'selected' : ''}>Evening (5-9pm)</option>
              <option value="night" ${s.time_of_day === 'night' ? 'selected' : ''}>Night (9pm-2am)</option>
            </select>
          </div>
          <div class="flex justify-end">
            <button onclick="deleteSeries('${s.folder_name}', '${s.display_name}')" class="text-red-400 hover:underline text-xs">Delete</button>
          </div>
        </div>
      `).join('');

      // Bind time selectors
      document.querySelectorAll('.time-select').forEach(sel => {
        sel.addEventListener('change', async function() {
          const series = this.dataset.series;
          const time = this.value;
          try {
            await fetch('/api/series/time_of_day', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ series_name: series, time_of_day: time })
            });
            this.style.borderColor = '#22c55e';
            setTimeout(() => { this.style.borderColor = ''; }, 1000);
          } catch (e) { console.error(e); }
        });
      });
    } catch (e) {
      document.getElementById('series-list').innerHTML = '<div class="text-red-400 text-sm">Error loading series</div>';
    }
  }

  async function deleteSeries(folderName, displayName) {
    if (!confirm(`Delete "${displayName}" and all its episodes?`)) return;
    try {
      const res = await fetch(`/series/delete/${encodeURIComponent(folderName)}`, { method: 'POST' });
      if (res.ok) loadSeries();
      else alert('Failed to delete series');
    } catch (e) { alert('Error deleting series'); }
  }

  // Series upload
  const seriesDropzone = document.getElementById('series-dropzone');
  const seriesFileInput = document.getElementById('series-file-input');
  const seriesUploadBtn = document.getElementById('series-upload-btn');

  seriesDropzone.addEventListener('click', () => seriesFileInput.click());
  seriesDropzone.addEventListener('dragover', e => { e.preventDefault(); seriesDropzone.classList.add('dragover'); });
  seriesDropzone.addEventListener('dragleave', () => seriesDropzone.classList.remove('dragover'));
  seriesDropzone.addEventListener('drop', e => {
    e.preventDefault();
    seriesDropzone.classList.remove('dragover');
    const dt = new DataTransfer();
    for (const f of e.dataTransfer.files) {
      if (f.name.toLowerCase().endsWith('.mp4')) dt.items.add(f);
    }
    seriesFileInput.files = dt.files;
    updateSeriesFileList();
  });
  seriesFileInput.addEventListener('change', updateSeriesFileList);

  function updateSeriesFileList() {
    const files = seriesFileInput.files;
    const container = document.getElementById('series-file-items');
    const listDiv = document.getElementById('series-file-list');
    container.innerHTML = '';

    if (files.length === 0) {
      listDiv.classList.add('hidden');
      seriesUploadBtn.disabled = true;
      return;
    }

    listDiv.classList.remove('hidden');
    for (const f of files) {
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerHTML = `
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <span class="flex-1 truncate text-xs">${f.name}</span>
      `;
      container.appendChild(item);
    }
    updateSeriesUploadBtn();
  }

  function updateSeriesUploadBtn() {
    const hasFiles = seriesFileInput.files.length > 0;
    const hasSeries = document.getElementById('series-select').value || document.getElementById('new-series-input').value.trim();
    seriesUploadBtn.disabled = !(hasFiles && hasSeries);
  }

  document.getElementById('series-select').addEventListener('change', () => {
    if (document.getElementById('series-select').value) document.getElementById('new-series-input').value = '';
    updateSeriesUploadBtn();
  });
  document.getElementById('new-series-input').addEventListener('input', () => {
    if (document.getElementById('new-series-input').value.trim()) document.getElementById('series-select').value = '';
    updateSeriesUploadBtn();
  });

  seriesUploadBtn.addEventListener('click', async () => {
    const files = Array.from(seriesFileInput.files);
    const series = document.getElementById('series-select').value;
    const newSeries = document.getElementById('new-series-input').value.trim();

    if (files.length === 0 || (!series && !newSeries)) return;

    seriesUploadBtn.disabled = true;
    seriesUploadBtn.textContent = 'Uploading...';
    const status = document.getElementById('series-upload-status');
    status.classList.remove('hidden');

    let completed = 0;
    for (const file of files) {
      status.textContent = `Uploading ${completed + 1}/${files.length}...`;
      status.className = 'mt-2 text-center text-sm text-gray-400';

      const formData = new FormData();
      formData.append('videos[]', file);
      formData.append('series', series);
      formData.append('new_series', newSeries);

      try {
        await fetch('/upload/series', { method: 'POST', body: formData });
        completed++;
      } catch (e) { console.error(e); }
    }

    status.textContent = `Uploaded ${completed} file(s)!`;
    status.className = 'mt-2 text-center text-sm text-green-400';
    seriesUploadBtn.textContent = 'Upload Episodes';
    seriesFileInput.value = '';
    document.getElementById('series-file-list').classList.add('hidden');
    loadSeries();
    setTimeout(() => { status.classList.add('hidden'); updateSeriesUploadBtn(); }, 2000);
  });

  // ============================================
  // COMMERCIALS
  // ============================================
  const commercialsExistingIds = new Set({{ commercials_existing_ids | default([]) | tojson }});

  async function loadCommercials() {
    try {
      const res = await fetch('/api/commercials');
      const data = await res.json();
      const container = document.getElementById('commercials-list');

      if (!data.ok || !data.commercials || data.commercials.length === 0) {
        container.innerHTML = '<div class="text-gray-500 italic text-sm col-span-3">No commercials yet. Upload some above.</div>';
        document.getElementById('commercials-count').textContent = '0';
        return;
      }

      document.getElementById('commercials-count').textContent = data.commercials.length;

      container.innerHTML = data.commercials.map(c => `
        <div class="content-card rounded-lg p-3">
          <div class="flex gap-2 mb-2">
            <img src="/thumbnails/${c.video_id}.jpg"
                 onerror="this.src='/thumbnails/default_thumbnail.png'"
                 class="w-16 h-16 object-cover rounded border border-gray-600">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-xs truncate text-white">${c.title}</h4>
              <p class="text-xs text-gray-400 mt-1">
                Duration: <span class="text-green-400">${formatDuration(c.duration)}</span>
              </p>
            </div>
          </div>
          <div class="flex gap-2">
            <a href="/edit/${c.video_id}" class="flex-1 text-center text-xs bg-gray-600 hover:bg-gray-700 text-white py-1 rounded">Edit</a>
            <button onclick="deleteCommercial('${c.video_id}', '${c.title.replace(/'/g, "\\'")}')"
                    class="flex-1 text-center text-xs bg-red-600 hover:bg-red-700 text-white py-1 rounded">Delete</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      document.getElementById('commercials-list').innerHTML = '<div class="text-red-400 text-sm">Error loading commercials</div>';
    }
  }

  async function deleteCommercial(videoId, title) {
    if (!confirm(`Delete commercial "${title}"?`)) return;
    try {
      const res = await fetch(`/api/commercials/${videoId}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.ok) loadCommercials();
      else alert('Error: ' + (data.error || 'Unknown'));
    } catch (e) { alert('Failed to delete commercial'); }
  }

  // Commercials upload
  const commercialsDropzone = document.getElementById('commercials-dropzone');
  const commercialsFileInput = document.getElementById('commercials-file-input');
  const commercialsUploadBtn = document.getElementById('commercials-upload-btn');

  commercialsDropzone.addEventListener('click', () => commercialsFileInput.click());
  commercialsDropzone.addEventListener('dragover', e => { e.preventDefault(); commercialsDropzone.classList.add('dragover'); });
  commercialsDropzone.addEventListener('dragleave', () => commercialsDropzone.classList.remove('dragover'));
  commercialsDropzone.addEventListener('drop', e => {
    e.preventDefault();
    commercialsDropzone.classList.remove('dragover');
    const dt = new DataTransfer();
    for (const f of e.dataTransfer.files) {
      if (f.name.toLowerCase().endsWith('.mp4')) dt.items.add(f);
    }
    commercialsFileInput.files = dt.files;
    updateCommercialsFileList();
  });
  commercialsFileInput.addEventListener('change', updateCommercialsFileList);

  function updateCommercialsFileList() {
    const files = commercialsFileInput.files;
    const container = document.getElementById('commercials-file-items');
    const listDiv = document.getElementById('commercials-file-list');
    container.innerHTML = '';

    if (files.length === 0) {
      listDiv.classList.add('hidden');
      commercialsUploadBtn.disabled = true;
      return;
    }

    listDiv.classList.remove('hidden');
    for (const f of files) {
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerHTML = `
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <span class="flex-1 truncate text-xs">${f.name}</span>
      `;
      container.appendChild(item);
    }
    commercialsUploadBtn.disabled = false;
  }

  commercialsUploadBtn.addEventListener('click', async () => {
    const files = Array.from(commercialsFileInput.files);
    if (files.length === 0) return;

    commercialsUploadBtn.disabled = true;
    commercialsUploadBtn.textContent = 'Uploading...';
    const status = document.getElementById('commercials-upload-status');
    status.classList.remove('hidden');

    let completed = 0;
    for (const file of files) {
      status.textContent = `Uploading ${completed + 1}/${files.length}...`;
      status.className = 'mt-2 text-center text-sm text-gray-400';

      const formData = new FormData();
      formData.append('videos[]', file);

      try {
        await fetch('/upload/commercials', { method: 'POST', body: formData });
        completed++;
      } catch (e) { console.error(e); }
    }

    status.textContent = `Uploaded ${completed} file(s)!`;
    status.className = 'mt-2 text-center text-sm text-green-400';
    commercialsUploadBtn.textContent = 'Upload Commercials';
    commercialsFileInput.value = '';
    document.getElementById('commercials-file-list').classList.add('hidden');
    loadCommercials();
    setTimeout(() => { status.classList.add('hidden'); commercialsUploadBtn.disabled = true; }, 2000);
  });

  // ============================================
  // INIT
  // ============================================
  document.addEventListener('DOMContentLoaded', () => {
    loadVcrVideos();
    loadTapes();
    updateReaderStatus();
    loadSeries();
    loadCommercials();

    setInterval(updateReaderStatus, 2000);
    setInterval(loadTapes, 10000);
  });
{% endblock %}
