<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta â€” Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     Â© 2025. No comercial, atribuciÃ³n y consulta previa. TAL CUAL, sin garantÃ­as.
     Ver LICENSE para tÃ©rminos completos.
-->
{% extends "base.html" %}

{% block title %}{{ tr("index.title") }}{% endblock %}

{% block extra_styles %}
  .video-card {
    background: rgba(17,24,39,.45);
    backdrop-filter: blur(2px);
    position: relative;
  }
  .video-card .delete-btn { position:absolute; top:.5rem; right:.5rem; z-index:30; }
  .category-badge {
    font-size: 0.65rem;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
  }
{% endblock %}

{% block content %}
  <!-- Stats -->
  <p class="text-xs sm:text-sm text-gray-400 text-center mb-4">
    {{ tr("index.stats.total_time") }}
    <span class="text-yellow-300 font-semibold">{{ recuerdos }}</span>
  </p>

  <!-- Title + Counter -->
  <div class="flex items-center justify-between mb-2">
    <h2 class="text-xl sm:text-2xl text-green-400 font-bold">{{ tr("index.videos.title") }}</h2>
    <div class="text-xs sm:text-sm text-gray-300">
      <span id="conteoTop" class="font-semibold">0</span> {{ tr("index.videos.count_label") }}
    </div>
  </div>

  <!-- Toggle filters -->
  <div class="flex items-center justify-end mb-3">
    <button
      id="toggleFiltros"
      class="text-xs sm:text-sm bg-gray-900/70 border border-gray-600 hover:border-yellow-500 rounded px-3 py-2"
      data-label-show="{{ tr('index.filters.toggle_show') }}"
      data-label-hide="{{ tr('index.filters.toggle_hide') }}"
    >
      {{ tr("index.filters.toggle_show") }}
    </button>
  </div>

  <!-- Filter Panel -->
  <section id="panelFiltros" class="mb-6 sm:mb-8 border border-yellow-700/40 rounded-lg p-3 sm:p-4 bg-gray-900/50 hide">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <!-- Channel Filter -->
      <div>
        <label class="block text-xs sm:text-sm text-gray-300 mb-1">{{ tr("index.filters.by_channel_label") }}</label>
        <select id="canalSelect" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm">
          <option value="">{{ tr("index.filters.by_channel_all") }}</option>
          {% if canales %}
            {% for canal_id, canal in (canales or {}).items() %}
              <option value="{{ canal_id }}">{{ canal.nombre or canal_id }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <!-- Category Filter -->
      <div>
        <label class="block text-xs sm:text-sm text-gray-300 mb-1">Category</label>
        <select id="categorySelect" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm">
          <option value="">All Categories</option>
          <option value="tv_episode">TV Episodes</option>
          <option value="movie">Movies</option>
          <option value="commercial">Commercials</option>
          <option value="vhs_tape">VHS Tapes</option>
        </select>
      </div>

      <!-- Sort Order -->
      <div>
        <label class="block text-xs sm:text-sm text-gray-300 mb-1">{{ tr("index.filters.order_label") }}</label>
        <select id="ordenSelect" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm">
          <option value="fecha_desc">{{ tr("index.filters.order.date_desc") }}</option>
          <option value="fecha_asc">{{ tr("index.filters.order.date_asc") }}</option>
          <option value="titulo_asc">{{ tr("index.filters.order.title_asc") }}</option>
          <option value="titulo_desc">{{ tr("index.filters.order.title_desc") }}</option>
          <option value="dur_asc">{{ tr("index.filters.order.dur_asc") }}</option>
          <option value="dur_desc">{{ tr("index.filters.order.dur_desc") }}</option>
        </select>
      </div>
    </div>

    <!-- Clear button -->
    <div class="mt-3 text-right">
      <button id="limpiarBtn" class="text-xs bg-gray-800 border border-gray-600 px-3 py-1.5 rounded hover:border-yellow-500">
        {{ tr("index.filters.clear_button") }}
      </button>
    </div>
  </section>

  <!-- NEW VIDEOS WITHOUT METADATA -->
  {% if nuevos %}
    <h3 class="text-lg sm:text-2xl text-blue-400 font-bold mt-2 mb-3 sm:mb-4">{{ tr("index.new_videos.header") }}</h3>
    <ul class="space-y-2 mb-6 sm:mb-10">
      {% for video_id in nuevos %}
      <li class="bg-gray-900/50 border border-blue-500 p-3 sm:p-4 rounded flex items-center justify-between">
        <div>
          <p class="text-base sm:text-lg font-semibold break-all">{{ video_id }}</p>
          <a href="{{ url_for('edit_video', video_id=video_id) }}" class="text-xs sm:text-sm text-blue-300 underline">{{ tr("index.new_videos.fill_metadata") }}</a>
        </div>
        <span class="text-[11px] sm:text-xs text-gray-300">{{ tr("index.new_videos.no_duration") }}</span>
      </li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- VIDEO LIST -->
  <div id="listaVideos" class="grid grid-cols-1 gap-4 sm:gap-6">
    {% for video_id, video in videos.items() %}
    <div class="video-card relative rounded-lg p-3 sm:p-4 shadow-lg border border-yellow-500 flex flex-col sm:flex-row gap-3 sm:gap-4 items-start"
         data-id="{{ video_id }}"
         data-title="{{ (video.title or '')|lower }}"
         data-fecha="{{ video.fecha or '' }}"
         data-duration="{{ video.duracion or 0 }}"
         data-category="{{ video.category or 'vhs_tape' }}"
         data-series="{{ video.series or '' }}">
      <!-- Delete button -->
      <button onclick="confirmFullDelete('{{ video_id }}')" class="delete-btn text-red-500 hover:text-white text-lg font-bold" title="Delete video">ðŸ—‘</button>

      <!-- Thumbnail + Duration -->
      <div class="relative w-full sm:w-28 sm:h-28">
        <img src="{{ url_for('serve_thumbnail', filename=video_id + '.jpg') }}"
             onerror="this.onerror=null;this.src='{{ url_for('serve_thumbnail', filename='default_thumbnail.png') }}';"
             class="w-full sm:w-28 sm:h-28 h-auto aspect-square object-cover rounded border border-yellow-600 relative z-0">
        <span class="absolute left-1 bottom-1 text-[11px] sm:text-xs px-1.5 py-0.5 rounded bg-gray-900/90 border border-gray-600" data-role="dur-label">â€”</span>
      </div>

      <!-- Info -->
      <div class="flex-1 w-full">
        <div class="flex items-center gap-2 mb-1 flex-wrap">
          <h4 class="text-lg sm:text-xl font-semibold break-words">{{ video.title }}</h4>
          {% set cat = video.category or 'vhs_tape' %}
          {% if cat == 'tv_episode' %}
            <span class="category-badge bg-purple-600 text-white">TV</span>
          {% elif cat == 'movie' %}
            <span class="category-badge bg-blue-600 text-white">Movie</span>
          {% elif cat == 'commercial' %}
            <span class="category-badge bg-green-600 text-white">Ad</span>
          {% else %}
            <span class="category-badge bg-gray-600 text-white">VHS</span>
          {% endif %}
        </div>
        {% if video.category == 'tv_episode' and video.series %}
        <p class="text-xs sm:text-sm text-purple-300">
          <strong>Series:</strong> {{ video.series }}
          {% if video.season %}S{{ video.season }}{% endif %}
          {% if video.episode %}E{{ video.episode }}{% endif %}
        </p>
        {% endif %}
        <p class="text-xs sm:text-sm text-gray-300"><strong>{{ tr("index.video_card.date") }}:</strong> {{ video.fecha }}</p>
        {% if video.personaje %}
        <p class="text-xs sm:text-sm text-gray-300"><strong>{{ tr("index.video_card.character") }}</strong> {{ video.personaje }}</p>
        {% endif %}
        <div class="flex gap-2 sm:gap-4 mt-3 flex-wrap">
          <a href="{{ url_for('video_detail', video_id=video_id) }}" class="text-xs sm:text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-1 rounded">{{ tr("index.video_card.view") }}</a>
          <a href="{{ url_for('edit_video', video_id=video_id) }}" class="text-xs sm:text-sm bg-yellow-600 hover:bg-yellow-700 text-black px-3 sm:px-4 py-1 rounded">{{ tr("index.video_card.edit") }}</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- GHOST ENTRIES -->
  {% if fantasmas %}
    <div class="flex justify-between items-center mt-10 mb-3 sm:mb-4">
      <h3 class="text-lg sm:text-2xl text-red-400 font-bold">{{ tr("index.ghosts.header") }}</h3>
      <button onclick="confirmDeleteAll()" class="text-xs sm:text-sm bg-red-600 hover:bg-red-700 text-white px-3 sm:px-4 py-1 rounded">{{ tr("index.ghosts.delete_all") }}</button>
    </div>
    <div class="grid grid-cols-1 gap-3 sm:gap-4">
      {% for video_id, video in fantasmas.items() %}
      <div class="bg-gray-900/50 p-3 sm:p-4 border border-red-500 rounded relative">
        <button onclick="confirmDelete('{{ video_id }}')" class="absolute top-2 right-2 text-red-400 hover:text-white font-bold text-lg">Ã—</button>
        <h3 class="text-lg sm:text-xl font-bold text-red-300 break-words">{{ video.title or video_id }}</h3>
        <p class="text-xs sm:text-sm text-gray-400">Date: {{ video.fecha or "?" }} | Character: {{ video.personaje or "?" }}</p>
        <a href="{{ url_for('edit_video', video_id=video_id) }}" class="text-xs sm:text-sm text-red-300 underline mt-2 inline-block">{{ tr("index.ghosts.edit_metadata") }}</a>
      </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  // Helpers
  function confirmDelete(videoId){ if(confirm("Delete metadata for '" + videoId + "'?")) window.location.href="/delete/"+videoId; }
  function confirmDeleteAll(){ if(confirm("This will delete ALL ghost entries (no video file). Continue?")) window.location.href="/delete_fantasmas"; }
  function confirmFullDelete(videoId){ if(confirm("This will delete the video file, metadata, and thumbnail. Are you sure?")) window.location.href="/delete_full/"+videoId; }
  function fmtDur(s){ s=Number(s)||0; const m=Math.floor(s/60); const ss=Math.floor(s%60); return `${m}:${ss.toString().padStart(2,'0')}`; }

  // Toggle filters
  const panelFiltros=document.getElementById('panelFiltros');
  const toggleBtn=document.getElementById('toggleFiltros');
  const STORAGE_KEY='tvargenta_filtros_visible';
  const labelShow = toggleBtn.dataset.labelShow || 'Show filters';
  const labelHide = toggleBtn.dataset.labelHide || 'Hide filters';

  function setFiltroVisible(on){
    panelFiltros.classList.toggle('hide', !on);
    toggleBtn.textContent = on ? labelHide : labelShow;
    try { localStorage.setItem(STORAGE_KEY, on ? '1' : '0'); } catch(e){}
  }

  const visibleInicial=(typeof localStorage!=='undefined' && localStorage.getItem(STORAGE_KEY)==='1');
  setFiltroVisible(visibleInicial);
  toggleBtn.addEventListener('click',()=>{ setFiltroVisible(panelFiltros.classList.contains('hide')); });

  // Data
  const CANALES={{ (canales or {}) | tojson }};
  const lista=document.getElementById('listaVideos');
  const cards=Array.from(document.querySelectorAll('.video-card'));
  const canalSelect=document.getElementById('canalSelect');
  const categorySelect=document.getElementById('categorySelect');
  const ordenSelect=document.getElementById('ordenSelect');
  const limpiarBtn=document.getElementById('limpiarBtn');
  const conteoTop=document.getElementById('conteoTop');

  // Duration labels
  cards.forEach(card=>{
    const s=Number(card.dataset.duration||0);
    const label=card.querySelector('[data-role="dur-label"]');
    label.textContent=s>0?fmtDur(s):'â€”';
  });

  // Clear filters
  limpiarBtn.addEventListener('click',()=>{
    canalSelect.value='';
    categorySelect.value='';
    ordenSelect.value='fecha_desc';
    aplicarFiltrosYOrden();
  });

  canalSelect.addEventListener('change',aplicarFiltrosYOrden);
  categorySelect.addEventListener('change',aplicarFiltrosYOrden);
  ordenSelect.addEventListener('change',aplicarFiltrosYOrden);

  function pasaFiltroCanal(card){
    const canalId=canalSelect.value;
    if(!canalId) return true;
    const regla=CANALES[canalId];
    if(!regla) return true;

    // Series filter
    const seriesFilter = regla.series_filter || [];
    if(seriesFilter.length > 0) {
      const cardCategory = card.dataset.category || 'vhs_tape';
      const cardSeries = card.dataset.series || '';
      if(cardCategory !== 'tv_episode') return false;
      if(!seriesFilter.includes(cardSeries)) return false;
    }
    return true;
  }

  function pasaFiltroCategory(card){
    const cat = categorySelect.value;
    if(!cat) return true;
    return card.dataset.category === cat;
  }

  function aplicarFiltrosYOrden(){
    let visibles=[];
    cards.forEach(c=>{
      const ok = pasaFiltroCanal(c) && pasaFiltroCategory(c);
      c.classList.toggle('hide',!ok);
      if(ok) visibles.push(c);
    });
    conteoTop.textContent=String(visibles.length);

    const criterio=ordenSelect.value;
    visibles.sort((a,b)=>{
      const da=Number(a.dataset.duration||0), db=Number(b.dataset.duration||0);
      const ta=a.dataset.title||'', tb=b.dataset.title||'';
      const fa=a.dataset.fecha||'', fb=b.dataset.fecha||'';
      switch(criterio){
        case 'dur_asc': return da-db;
        case 'dur_desc': return db-da;
        case 'titulo_asc': return ta.localeCompare(tb,'es');
        case 'titulo_desc': return tb.localeCompare(ta,'es');
        case 'fecha_desc': return (fb||'').localeCompare(fa||'');
        case 'fecha_asc': return (fa||'').localeCompare(fb||'');
        default: return 0;
      }
    });
    const frag=document.createDocumentFragment();
    visibles.forEach(c=>frag.appendChild(c));
    lista.appendChild(frag);
  }

  // Initial pass
  aplicarFiltrosYOrden();
{% endblock %}
