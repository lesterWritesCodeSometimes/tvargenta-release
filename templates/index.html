<!-- SPDX-License-Identifier: LicenseRef-TVArgenta-NC-Attribution-Consult-First
     Proyecto: TVArgenta ‚Äî Retro TV | Autor: Ricardo Sappia (rsflightronics@gmail.com)
     ¬© 2025. No comercial, atribuci√≥n y consulta previa. TAL CUAL, sin garant√≠as.
     Ver LICENSE para t√©rminos completos.
-->
{% extends "base.html" %}

{% block title %}{{ tr("index.title") }}{% endblock %}

{% block extra_styles %}
  .section-card {
    background: rgba(17,24,39,.6);
    backdrop-filter: blur(2px);
  }
  .section-header {
    cursor: pointer;
    user-select: none;
  }
  .section-header:hover {
    background: rgba(255,255,255,0.05);
  }
  .dropzone {
    border: 2px dashed #4b5563;
    transition: all 0.3s ease;
  }
  .dropzone.dragover {
    border-color: #a855f7;
    background-color: rgba(147, 51, 234, 0.1);
  }
  .dropzone-green.dragover {
    border-color: #22c55e;
    background-color: rgba(34, 197, 94, 0.1);
  }
  .dropzone-blue.dragover {
    border-color: #3b82f6;
    background-color: rgba(59, 130, 246, 0.1);
  }
  .dropzone-yellow.dragover {
    border-color: #facc15;
    background-color: rgba(250, 204, 21, 0.1);
  }
  .file-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: #1f2937;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
  }
  .file-item .progress-bar {
    width: 40px;
    height: 8px;
    background: #374151;
    border-radius: 4px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .file-item .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #9333ea, #a855f7);
    width: 0%;
    transition: width 0.2s ease;
  }
  .content-card {
    background: rgba(17,24,39,0.8);
    border: 1px solid #374151;
    transition: border-color 0.2s, transform 0.2s;
  }
  .content-card:hover {
    border-color: #9333ea;
  }
  .tape-inserted {
    border-color: #22c55e !important;
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
  }
  .inserted-badge {
    animation: pulse-glow 2s ease-in-out infinite;
  }
  @keyframes pulse-glow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  .scanning { animation: pulse-glow 1.5s ease-in-out infinite; }

  /* Series expanding cards */
  .series-card {
    background: rgba(17,24,39,.6);
    backdrop-filter: blur(2px);
    transition: all 0.3s ease;
  }
  .series-card:hover {
    box-shadow: 0 4px 12px rgba(147, 51, 234, 0.2);
  }
  .series-card.expanded {
    border-color: #a855f7;
    box-shadow: 0 4px 20px rgba(147, 51, 234, 0.3);
  }
  .series-card .card-form {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease;
    padding-top: 0;
    margin-top: 0;
  }
  .series-card.expanded .card-form {
    max-height: 2000px;
    padding-top: 1rem;
    margin-top: 1rem;
    border-top: 1px solid #4b5563;
  }
  .create-series-card {
    border: 2px dashed #4b5563;
    background: rgba(17,24,39,.3);
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .create-series-card:hover {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
  }
  .create-series-card.expanded {
    border-style: solid;
    border-color: #22c55e;
    cursor: default;
    background: rgba(17,24,39,.6);
  }
  .create-series-card .card-form {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
    padding-top: 0;
  }
  .create-series-card.expanded .card-form {
    max-height: 200px;
    padding-top: 1rem;
  }

  /* Season expansion */
  .season-item {
    background: rgba(31,41,55,0.8);
    transition: all 0.2s ease;
  }
  .season-item:hover {
    background: rgba(31,41,55,1);
  }
  .season-item.expanded {
    background: rgba(88,28,135,0.3);
  }
  .season-episodes {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .season-item.expanded .season-episodes {
    max-height: 1000px;
  }
  .episode-item {
    background: rgba(17,24,39,0.6);
    transition: background 0.2s ease;
  }
  .episode-item:hover {
    background: rgba(17,24,39,0.9);
  }
{% endblock %}

{% block content %}
  <!-- Stats -->
  <p class="text-xs sm:text-sm text-gray-400 text-center mb-6">
    {{ tr("index.stats.total_time") }}
    <span class="text-yellow-300 font-semibold">{{ recuerdos }}</span>
  </p>

  <!-- ============================================ -->
  <!-- TV SERIES SECTION -->
  <!-- ============================================ -->
  <section class="section-card rounded-lg border border-purple-600 mb-4 overflow-hidden">
    <div class="section-header flex items-center justify-between p-4 bg-purple-900/30" onclick="toggleSection('series')">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üì∫</span>
        <div>
          <h2 class="text-lg font-bold text-purple-400">TV Series</h2>
          <p class="text-xs text-gray-400"><span id="series-count">0</span> series</p>
        </div>
      </div>
      <span id="series-toggle" class="text-xl text-gray-400">‚ñº</span>
    </div>

    <div id="series-content" class="p-4">
      <!-- Series Cards Container -->
      <div id="series-list" class="space-y-3">
        <div class="text-gray-500 italic text-sm">Loading...</div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- MOVIES SECTION -->
  <!-- ============================================ -->
  <section class="section-card rounded-lg border border-blue-600 mb-4 overflow-hidden">
    <div class="section-header flex items-center justify-between p-4 bg-blue-900/30" onclick="toggleSection('movies')">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üé¨</span>
        <div>
          <h2 class="text-lg font-bold text-blue-400">Movies</h2>
          <p class="text-xs text-gray-400"><span id="movies-count">0</span> movies</p>
        </div>
      </div>
      <span id="movies-toggle" class="text-xl text-gray-400">‚ñº</span>
    </div>

    <div id="movies-content" class="p-4">
      <!-- Upload Movies -->
      <div class="mb-4 p-3 bg-gray-900/50 rounded-lg border border-blue-500/50">
        <h3 class="text-sm font-bold text-blue-300 mb-2">Upload Movies</h3>
        <div id="movies-dropzone" class="dropzone dropzone-blue rounded-lg p-4 text-center cursor-pointer mb-2">
          <input type="file" id="movies-file-input" multiple accept=".mp4" class="hidden">
          <p class="text-gray-300 text-sm">Drop movie files here</p>
        </div>
        <div id="movies-file-list" class="hidden mb-2">
          <div id="movies-file-items"></div>
        </div>
        <div class="flex justify-end gap-2">
          <span id="movies-upload-status" class="text-xs text-gray-400 self-center"></span>
          <button id="movies-upload-btn" disabled
                  class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold px-3 py-1.5 rounded text-sm">
            Upload
          </button>
        </div>
      </div>

      <!-- Movies List -->
      <div id="movies-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <div class="text-gray-500 italic text-sm">Loading...</div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- COMMERCIALS SECTION -->
  <!-- ============================================ -->
  <section class="section-card rounded-lg border border-green-600 mb-4 overflow-hidden">
    <div class="section-header flex items-center justify-between p-4 bg-green-900/30" onclick="toggleSection('commercials')">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üì¢</span>
        <div>
          <h2 class="text-lg font-bold text-green-400">Commercials</h2>
          <p class="text-xs text-gray-400"><span id="commercials-count">0</span> commercials</p>
        </div>
      </div>
      <span id="commercials-toggle" class="text-xl text-gray-400">‚ñº</span>
    </div>

    <div id="commercials-content" class="p-4">
      <!-- Upload Commercials -->
      <div class="mb-4 p-3 bg-gray-900/50 rounded-lg border border-green-500/50">
        <h3 class="text-sm font-bold text-green-300 mb-2">Upload Commercials</h3>
        <div id="commercials-dropzone" class="dropzone dropzone-green rounded-lg p-4 text-center cursor-pointer mb-2">
          <input type="file" id="commercials-file-input" multiple accept=".mp4" class="hidden">
          <p class="text-gray-300 text-sm">Drop commercial files here</p>
        </div>
        <div id="commercials-file-list" class="hidden mb-2">
          <div id="commercials-file-items"></div>
        </div>
        <div class="flex justify-end gap-2">
          <span id="commercials-upload-status" class="text-xs text-gray-400 self-center"></span>
          <button id="commercials-upload-btn" disabled
                  class="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold px-3 py-1.5 rounded text-sm">
            Upload
          </button>
        </div>
      </div>

      <!-- Commercials List -->
      <div id="commercials-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <div class="text-gray-500 italic text-sm">Loading...</div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- VHS TAPES SECTION -->
  <!-- ============================================ -->
  <section class="section-card rounded-lg border border-yellow-600 mb-4 overflow-hidden">
    <div class="section-header flex items-center justify-between p-4 bg-yellow-900/30" onclick="toggleSection('vhs')">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üìº</span>
        <div>
          <h2 class="text-lg font-bold text-yellow-400">VHS Tapes</h2>
          <p class="text-xs text-gray-400"><span id="vhs-count">0</span> tapes</p>
        </div>
      </div>
      <span id="vhs-toggle" class="text-xl text-gray-400">‚ñº</span>
    </div>

    <div id="vhs-content" class="p-4">
      <!-- NFC Reader Status -->
      <div id="reader-status" class="mb-4 p-3 rounded-lg border-2 border-gray-600 bg-gray-900/50">
        <div class="flex items-center gap-3">
          <span id="reader-icon" class="text-2xl">üîå</span>
          <div class="flex-1">
            <div id="reader-text" class="font-bold text-sm">Checking NFC Reader...</div>
            <div id="reader-detail" class="text-xs text-gray-400"></div>
          </div>
        </div>
      </div>

      <!-- Register New Tape (shown when unregistered tape detected) -->
      <div id="register-tape-section" class="hidden mb-4 p-3 bg-green-900/30 rounded-lg border border-green-500">
        <h3 class="text-sm font-bold text-green-400 mb-2">New Tape Detected!</h3>
        <p class="text-xs text-gray-300 mb-2">UID: <span id="detected-uid" class="font-mono"></span></p>
        <form id="register-form" class="space-y-2">
          <input type="hidden" id="register-uid">
          <div>
            <label class="block text-xs mb-1 text-gray-300">Assign to Video:</label>
            <select id="register-video" required class="w-full bg-gray-800 text-white px-2 py-1.5 rounded border border-gray-600 text-sm">
              <option value="">-- Select video --</option>
            </select>
          </div>
          <div>
            <label class="block text-xs mb-1 text-gray-300">Custom Label (optional):</label>
            <input type="text" id="register-title" placeholder="e.g. Summer Vacation 1995"
                   class="w-full bg-gray-800 text-white px-2 py-1.5 rounded border border-gray-600 text-sm">
          </div>
          <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 rounded text-sm">
            Register Tape
          </button>
        </form>
      </div>

      <!-- VHS Tapes List -->
      <div id="vhs-list" class="space-y-2">
        <div class="text-gray-500 italic text-sm">Loading...</div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- DEBUG SECTION (Collapsed) -->
  <!-- ============================================ -->
  {% if nuevos or fantasmas %}
  <details class="section-card rounded-lg border border-red-600/50 mb-4">
    <summary class="p-3 cursor-pointer text-red-400 hover:bg-red-900/20">
      Debug: {{ (nuevos|length) + (fantasmas|length) }} issue(s)
    </summary>
    <div class="p-4 border-t border-red-600/30">
      {% if nuevos %}
      <div class="mb-4">
        <h3 class="text-sm font-bold text-blue-400 mb-2">New Files (no metadata)</h3>
        {% for video_id in nuevos %}
        <div class="flex items-center justify-between bg-gray-900/50 p-2 rounded mb-1 text-sm">
          <span class="font-mono text-xs truncate flex-1">{{ video_id }}</span>
          <a href="{{ url_for('edit_video', video_id=video_id) }}" class="text-blue-400 hover:underline text-xs ml-2">Add metadata</a>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% if fantasmas %}
      <div>
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-bold text-red-400">Ghost Entries (no file)</h3>
          <button onclick="confirmDeleteAllGhosts()" class="text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Delete All</button>
        </div>
        {% for video_id, video in fantasmas.items() %}
        <div class="flex items-center justify-between bg-gray-900/50 p-2 rounded mb-1 text-sm">
          <span class="truncate flex-1">{{ video.title or video_id }}</span>
          <div class="flex gap-2 ml-2">
            <a href="{{ url_for('edit_video', video_id=video_id) }}" class="text-yellow-400 hover:underline text-xs">Edit</a>
            <button onclick="confirmDeleteGhost('{{ video_id }}')" class="text-red-400 hover:underline text-xs">Delete</button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </details>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  // ============================================
  // HELPERS
  // ============================================
  function formatDuration(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  }

  function confirmDeleteGhost(videoId) {
    if (confirm("Delete ghost entry '" + videoId + "'?")) {
      window.location.href = "/delete/" + videoId;
    }
  }

  function confirmDeleteAllGhosts() {
    if (confirm("Delete ALL ghost entries?")) {
      window.location.href = "/delete_fantasmas";
    }
  }

  // ============================================
  // SECTION TOGGLE
  // ============================================
  function toggleSection(section) {
    const content = document.getElementById(section + '-content');
    const toggle = document.getElementById(section + '-toggle');
    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    toggle.textContent = isHidden ? '‚ñº' : '‚ñ∂';
    localStorage.setItem('lib_section_' + section, isHidden ? 'open' : 'closed');
  }

  // Restore section states
  ['series', 'movies', 'commercials', 'vhs'].forEach(section => {
    const state = localStorage.getItem('lib_section_' + section);
    if (state === 'closed') {
      document.getElementById(section + '-content').style.display = 'none';
      document.getElementById(section + '-toggle').textContent = '‚ñ∂';
    }
  });

  // ============================================
  // UPLOAD HELPER (reusable)
  // ============================================

  // Get video_id from filename (mimics Python's secure_filename + extension removal)
  function getVideoIdFromFilename(filename) {
    // Mimic Werkzeug's secure_filename behavior
    let safe = filename
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')  // Remove accents
      .replace(/[^\w.\s-]/g, '')  // Keep only word chars, dots, spaces, hyphens
      .trim()
      .replace(/[\s]+/g, '_')  // Replace whitespace with underscores
      .replace(/^[._]+|[._]+$/g, '');  // Strip leading/trailing dots and underscores
    // Remove extension
    return safe.replace(/\.[^/.]+$/, '');
  }

  // Upload a single file with XMLHttpRequest for progress tracking
  function uploadFileWithProgress(url, formData, onProgress) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable && onProgress) {
          const percent = Math.round((e.loaded / e.total) * 100);
          onProgress(percent);
        }
      };

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            resolve(JSON.parse(xhr.responseText));
          } catch {
            resolve({ ok: true });
          }
        } else {
          reject(new Error(`Upload failed: ${xhr.status}`));
        }
      };

      xhr.onerror = () => reject(new Error('Network error'));
      xhr.send(formData);
    });
  }

  function setupUploader(config) {
    const dropzone = document.getElementById(config.dropzoneId);
    const fileInput = document.getElementById(config.fileInputId);
    const fileList = document.getElementById(config.fileListId);
    const fileItems = document.getElementById(config.fileItemsId);
    const uploadBtn = document.getElementById(config.uploadBtnId);
    const statusEl = document.getElementById(config.statusId);

    let existingIds = new Set();
    let duplicateFiles = new Set();

    // Load existing IDs for duplicate detection
    async function loadExistingIds() {
      if (config.existingIdsUrl) {
        try {
          const res = await fetch(config.existingIdsUrl);
          const data = await res.json();
          if (data.ok) {
            const items = data.movies || data.commercials || [];
            existingIds = new Set(items.map(item => item.video_id));
          }
        } catch (e) { console.error('Failed to load existing IDs:', e); }
      }
    }

    loadExistingIds();

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const dt = new DataTransfer();
      for (const f of e.dataTransfer.files) {
        if (f.name.toLowerCase().endsWith('.mp4')) dt.items.add(f);
      }
      fileInput.files = dt.files;
      updateFileList();
    });
    fileInput.addEventListener('change', updateFileList);

    function updateFileList() {
      const files = fileInput.files;
      fileItems.innerHTML = '';
      duplicateFiles.clear();

      if (files.length === 0) {
        fileList.classList.add('hidden');
        uploadBtn.disabled = true;
        return;
      }

      fileList.classList.remove('hidden');
      for (const f of files) {
        const videoId = getVideoIdFromFilename(f.name);
        const isDuplicate = existingIds.has(videoId);

        if (isDuplicate) {
          duplicateFiles.add(f.name);
        }

        const item = document.createElement('div');
        item.className = 'file-item';
        item.dataset.filename = f.name;

        if (isDuplicate) {
          item.innerHTML = `<span class="text-yellow-400 mr-2">‚äò</span><span class="flex-1 truncate text-xs text-yellow-300">${f.name}</span><span class="text-xs text-yellow-500 ml-2">Already exists</span>`;
        } else {
          item.innerHTML = `<div class="progress-bar"><div class="progress-fill"></div></div><span class="flex-1 truncate text-xs">${f.name}</span>`;
        }
        fileItems.appendChild(item);
      }

      // Enable upload only if there are non-duplicate files
      const hasNewFiles = files.length > duplicateFiles.size;
      if (config.checkReady) config.checkReady();
      else uploadBtn.disabled = !hasNewFiles;
    }

    uploadBtn.addEventListener('click', async () => {
      const allFiles = Array.from(fileInput.files);
      // Filter out duplicates
      const files = allFiles.filter(f => !duplicateFiles.has(f.name));
      const skipped = duplicateFiles.size;

      if (files.length === 0) {
        statusEl.textContent = skipped > 0 ? `All ${skipped} file(s) already exist` : 'No files';
        setTimeout(() => { statusEl.textContent = ''; }, 2000);
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';

      let completed = 0;
      let errors = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const itemEl = fileItems.querySelector(`[data-filename="${CSS.escape(file.name)}"]`);
        const progressFill = itemEl?.querySelector('.progress-fill');

        statusEl.textContent = `Uploading ${completed + 1}/${files.length}...`;

        const formData = new FormData();
        formData.append('videos[]', file);
        if (config.extraFormData) config.extraFormData(formData);

        try {
          const result = await uploadFileWithProgress(
            config.uploadUrl,
            formData,
            (percent) => {
              if (progressFill) progressFill.style.width = `${percent}%`;
            }
          );

          if (result.error === 'already_exists') {
            if (itemEl) itemEl.innerHTML = `<span class="text-yellow-400 mr-2">‚äò</span><span class="flex-1 truncate text-xs text-yellow-300">${file.name}</span><span class="text-xs text-yellow-500 ml-2">Already exists</span>`;
            existingIds.add(getVideoIdFromFilename(file.name));
          } else {
            completed++;
            if (itemEl) itemEl.innerHTML = `<span class="text-green-400 mr-2">&#10003;</span><span class="flex-1 truncate text-xs text-green-300">${file.name}</span>`;
            existingIds.add(getVideoIdFromFilename(file.name));
          }
        } catch (e) {
          console.error(e);
          errors++;
          if (itemEl) itemEl.innerHTML = `<span class="text-red-400 mr-2">&#10007;</span><span class="flex-1 truncate text-xs text-red-300">${file.name}</span>`;
        }
      }

      let msg = `Done! ${completed} uploaded`;
      if (skipped > 0) msg += `, ${skipped} skipped`;
      if (errors > 0) msg += `, ${errors} failed`;
      statusEl.textContent = msg;
      uploadBtn.textContent = 'Upload';
      fileInput.value = '';
      if (config.onComplete) config.onComplete();
      setTimeout(() => { statusEl.textContent = ''; fileList.classList.add('hidden'); uploadBtn.disabled = true; }, 2500);
    });

    return {
      updateFileList,
      checkReady: () => { if (config.checkReady) config.checkReady(); },
      refreshExistingIds: loadExistingIds
    };
  }

  // ============================================
  // TV SERIES
  // ============================================
  let expandedSeriesCard = null;
  let expandedSeason = {};  // { seriesName: seasonNum }
  let seriesData = [];      // Store loaded series data for re-rendering

  const TIME_OF_DAY_LABELS = {
    'any': 'Any Time',
    'early_morning': 'Early Morning',
    'late_morning': 'Late Morning',
    'afternoon': 'Afternoon',
    'evening': 'Evening',
    'night': 'Night'
  };

  function toggleSeriesCard(seriesName, event) {
    if (event) event.stopPropagation();

    const card = document.querySelector(`[data-series-id="${seriesName}"]`);
    if (!card) return;

    const isExpanding = !card.classList.contains('expanded');

    // Collapse any currently expanded card
    if (expandedSeriesCard && expandedSeriesCard !== seriesName) {
      const prevCard = document.querySelector(`[data-series-id="${expandedSeriesCard}"]`);
      if (prevCard) prevCard.classList.remove('expanded');
    }

    // Toggle this card
    if (isExpanding) {
      card.classList.add('expanded');
      expandedSeriesCard = seriesName;
      // Reset expanded season for this series
      expandedSeason[seriesName] = null;
      // Initialize dropzone for this series
      setTimeout(() => initSeriesDropzone(seriesName), 100);
      // Scroll into view
      setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
    } else {
      card.classList.remove('expanded');
      expandedSeriesCard = null;
    }
  }

  function toggleSeason(seriesName, seasonNum, event) {
    if (event) event.stopPropagation();

    const seasonItem = document.querySelector(`[data-series="${seriesName}"][data-season="${seasonNum}"]`);
    if (!seasonItem) return;

    const isExpanding = !seasonItem.classList.contains('expanded');

    // Collapse any currently expanded season in this series
    if (expandedSeason[seriesName] && expandedSeason[seriesName] !== seasonNum) {
      const prevSeason = document.querySelector(`[data-series="${seriesName}"][data-season="${expandedSeason[seriesName]}"]`);
      if (prevSeason) prevSeason.classList.remove('expanded');
    }

    // Toggle this season
    if (isExpanding) {
      seasonItem.classList.add('expanded');
      expandedSeason[seriesName] = seasonNum;
    } else {
      seasonItem.classList.remove('expanded');
      expandedSeason[seriesName] = null;
    }
  }

  function initSeriesDropzone(seriesName) {
    const dropzone = document.getElementById(`dropzone-${seriesName}`);
    const fileInput = document.getElementById(`file-input-${seriesName}`);
    const fileList = document.getElementById(`file-list-${seriesName}`);
    const fileItems = document.getElementById(`file-items-${seriesName}`);
    const uploadBtn = document.getElementById(`upload-btn-${seriesName}`);
    const statusEl = document.getElementById(`upload-status-${seriesName}`);

    if (!dropzone || dropzone.dataset.initialized) return;
    dropzone.dataset.initialized = 'true';

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const dt = new DataTransfer();
      for (const f of e.dataTransfer.files) {
        if (f.name.toLowerCase().endsWith('.mp4')) dt.items.add(f);
      }
      fileInput.files = dt.files;
      updateSeriesFileList(seriesName);
    });
    fileInput.addEventListener('change', () => updateSeriesFileList(seriesName));

    uploadBtn.addEventListener('click', () => uploadSeriesFiles(seriesName));
  }

  // Get existing episode video_ids for a series
  function getSeriesExistingIds(seriesName) {
    const series = seriesData.find(s => s.folder_name === seriesName);
    if (!series || !series.seasons) return new Set();
    const ids = new Set();
    for (const season of series.seasons) {
      for (const ep of season.episodes) {
        ids.add(ep.video_id);
      }
    }
    return ids;
  }

  // Track duplicates per series
  const seriesDuplicates = {};

  function updateSeriesFileList(seriesName) {
    const fileInput = document.getElementById(`file-input-${seriesName}`);
    const fileList = document.getElementById(`file-list-${seriesName}`);
    const fileItems = document.getElementById(`file-items-${seriesName}`);
    const uploadBtn = document.getElementById(`upload-btn-${seriesName}`);

    const files = fileInput.files;
    fileItems.innerHTML = '';
    seriesDuplicates[seriesName] = new Set();

    if (files.length === 0) {
      fileList.classList.add('hidden');
      uploadBtn.disabled = true;
      return;
    }

    const existingIds = getSeriesExistingIds(seriesName);
    fileList.classList.remove('hidden');

    for (const f of files) {
      const videoId = getVideoIdFromFilename(f.name);
      const isDuplicate = existingIds.has(videoId);

      if (isDuplicate) {
        seriesDuplicates[seriesName].add(f.name);
      }

      const item = document.createElement('div');
      item.className = 'file-item';
      item.dataset.filename = f.name;

      if (isDuplicate) {
        item.innerHTML = `<span class="text-yellow-400 mr-2">‚äò</span><span class="flex-1 truncate text-xs text-yellow-300">${f.name}</span><span class="text-xs text-yellow-500 ml-2">Already exists</span>`;
      } else {
        item.innerHTML = `<div class="progress-bar"><div class="progress-fill"></div></div><span class="flex-1 truncate text-xs">${f.name}</span>`;
      }
      fileItems.appendChild(item);
    }

    // Enable upload only if there are non-duplicate files
    const hasNewFiles = files.length > seriesDuplicates[seriesName].size;
    uploadBtn.disabled = !hasNewFiles;
  }

  async function uploadSeriesFiles(seriesName) {
    const fileInput = document.getElementById(`file-input-${seriesName}`);
    const uploadBtn = document.getElementById(`upload-btn-${seriesName}`);
    const statusEl = document.getElementById(`upload-status-${seriesName}`);
    const fileList = document.getElementById(`file-list-${seriesName}`);
    const fileItems = document.getElementById(`file-items-${seriesName}`);

    const allFiles = Array.from(fileInput.files);
    const duplicates = seriesDuplicates[seriesName] || new Set();
    const files = allFiles.filter(f => !duplicates.has(f.name));
    const skipped = duplicates.size;

    if (files.length === 0) {
      statusEl.textContent = skipped > 0 ? `All ${skipped} file(s) already exist` : 'No files';
      setTimeout(() => { statusEl.textContent = ''; }, 2000);
      return;
    }

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading...';

    let completed = 0;
    let errors = 0;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const itemEl = fileItems.querySelector(`[data-filename="${CSS.escape(file.name)}"]`);
      const progressFill = itemEl?.querySelector('.progress-fill');

      statusEl.textContent = `Uploading ${completed + 1}/${files.length}...`;

      const formData = new FormData();
      formData.append('videos[]', file);
      formData.append('series', seriesName);

      try {
        const result = await uploadFileWithProgress(
          '/upload/series',
          formData,
          (percent) => {
            if (progressFill) progressFill.style.width = `${percent}%`;
          }
        );

        if (result.error === 'already_exists') {
          if (itemEl) itemEl.innerHTML = `<span class="text-yellow-400 mr-2">‚äò</span><span class="flex-1 truncate text-xs text-yellow-300">${file.name}</span><span class="text-xs text-yellow-500 ml-2">Already exists</span>`;
        } else {
          completed++;
          if (itemEl) itemEl.innerHTML = `<span class="text-green-400 mr-2">&#10003;</span><span class="flex-1 truncate text-xs text-green-300">${file.name}</span>`;
        }
      } catch (e) {
        console.error(e);
        errors++;
        if (itemEl) itemEl.innerHTML = `<span class="text-red-400 mr-2">&#10007;</span><span class="flex-1 truncate text-xs text-red-300">${file.name}</span>`;
      }
    }

    let msg = `Done! ${completed} uploaded`;
    if (skipped > 0) msg += `, ${skipped} skipped`;
    if (errors > 0) msg += `, ${errors} failed`;
    statusEl.textContent = msg;
    uploadBtn.textContent = 'Upload';
    fileInput.value = '';
    loadSeries();
    setTimeout(() => { statusEl.textContent = ''; fileList.classList.add('hidden'); uploadBtn.disabled = true; }, 2500);
  }

  async function updateSeriesTimeOfDay(seriesName, timeOfDay) {
    await fetch('/api/series/time_of_day', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ series_name: seriesName, time_of_day: timeOfDay })
    });
  }

  async function deleteEpisode(videoId, seriesName) {
    if (!confirm('Delete this episode?')) return;
    await fetch(`/delete/${videoId}`);
    loadSeries();
  }

  async function deleteSeries(folderName, displayName) {
    if (!confirm(`Delete "${displayName}" and all episodes?`)) return;
    await fetch(`/series/delete/${encodeURIComponent(folderName)}`, { method: 'POST' });
    loadSeries();
  }

  function renderSeriesCards() {
    const container = document.getElementById('series-list');

    if (seriesData.length === 0) {
      container.innerHTML = renderCreateSeriesCard();
      initCreateSeriesCard();
      return;
    }

    let html = seriesData.map(s => {
      const timeLabel = TIME_OF_DAY_LABELS[s.time_of_day] || 'Any Time';
      const isExpanded = expandedSeriesCard === s.folder_name;

      // Build seasons HTML
      let seasonsHtml = '';
      if (s.seasons && s.seasons.length > 0) {
        seasonsHtml = s.seasons.map(season => {
          const isSeasonExpanded = expandedSeason[s.folder_name] === season.season;
          const episodesHtml = season.episodes.map(ep => `
            <div class="episode-item flex items-center justify-between p-2 rounded text-sm">
              <div class="flex-1 min-w-0">
                <span class="text-white">${ep.title}</span>
                <span class="text-gray-500 ml-2">S${String(ep.season).padStart(2,'0')}E${String(ep.episode).padStart(2,'0')}</span>
                <span class="text-gray-500 ml-2">${formatDuration(ep.duration)}</span>
              </div>
              <div class="flex gap-2 ml-2">
                <a href="/edit/${ep.video_id}" class="text-blue-400 hover:underline text-xs">Edit</a>
                <button onclick="deleteEpisode('${ep.video_id}', '${s.folder_name}')" class="text-red-400 hover:underline text-xs">Delete</button>
              </div>
            </div>
          `).join('');

          return `
            <div class="season-item rounded-lg overflow-hidden ${isSeasonExpanded ? 'expanded' : ''}"
                 data-series="${s.folder_name}" data-season="${season.season}">
              <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleSeason('${s.folder_name}', ${season.season}, event)">
                <span class="font-semibold text-purple-300">Season ${season.season}</span>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-400">${season.episodes.length} episodes</span>
                  <span class="text-gray-400">${isSeasonExpanded ? '‚ñº' : '‚ñ∂'}</span>
                </div>
              </div>
              <div class="season-episodes">
                <div class="p-2 pt-0 space-y-1">
                  ${episodesHtml || '<p class="text-gray-500 text-xs p-2">No episodes</p>'}
                </div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        seasonsHtml = '<p class="text-gray-500 text-sm">No episodes uploaded yet</p>';
      }

      return `
        <div class="series-card border border-purple-600 rounded-lg p-4 ${isExpanded ? 'expanded' : ''}" data-series-id="${s.folder_name}">
          <!-- Collapsed View -->
          <div class="card-header cursor-pointer" onclick="toggleSeriesCard('${s.folder_name}')">
            <div class="flex items-center justify-between">
              <div class="flex-1 min-w-0">
                <h3 class="text-lg font-bold text-white truncate">${s.display_name}</h3>
              </div>
              <div class="flex items-center gap-4 ml-4">
                <span class="text-sm text-purple-300">${s.episode_count} ep</span>
                <span class="text-xs text-gray-400 px-2 py-0.5 bg-gray-700 rounded">${timeLabel}</span>
                <span class="text-gray-400">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
              </div>
            </div>
          </div>

          <!-- Expanded Form -->
          <div class="card-form">
            <!-- Upload Area -->
            <div class="mb-4 p-3 bg-gray-900/50 rounded-lg border border-purple-500/30">
              <h4 class="text-sm font-semibold text-purple-300 mb-2">Upload Episodes</h4>
              <div id="dropzone-${s.folder_name}" class="dropzone rounded-lg p-4 text-center cursor-pointer mb-2">
                <input type="file" id="file-input-${s.folder_name}" multiple accept=".mp4" class="hidden">
                <p class="text-gray-300 text-sm">Drop episode files here <span class="text-gray-500">(S01E05.mp4, 1x05.mp4)</span></p>
              </div>
              <div id="file-list-${s.folder_name}" class="hidden mb-2">
                <div id="file-items-${s.folder_name}"></div>
              </div>
              <div class="flex justify-end gap-2">
                <span id="upload-status-${s.folder_name}" class="text-xs text-gray-400 self-center"></span>
                <button id="upload-btn-${s.folder_name}" disabled
                        class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold px-3 py-1.5 rounded text-sm">
                  Upload
                </button>
              </div>
            </div>

            <!-- Broadcast Time -->
            <div class="mb-4 flex items-center gap-3">
              <label class="text-sm text-gray-300">Broadcast Time:</label>
              <select class="bg-gray-800 text-white px-3 py-1.5 rounded border border-gray-600 text-sm"
                      onchange="updateSeriesTimeOfDay('${s.folder_name}', this.value)">
                <option value="any" ${s.time_of_day === 'any' ? 'selected' : ''}>Any Time</option>
                <option value="early_morning" ${s.time_of_day === 'early_morning' ? 'selected' : ''}>Early Morning</option>
                <option value="late_morning" ${s.time_of_day === 'late_morning' ? 'selected' : ''}>Late Morning</option>
                <option value="afternoon" ${s.time_of_day === 'afternoon' ? 'selected' : ''}>Afternoon</option>
                <option value="evening" ${s.time_of_day === 'evening' ? 'selected' : ''}>Evening</option>
                <option value="night" ${s.time_of_day === 'night' ? 'selected' : ''}>Night</option>
              </select>
            </div>

            <!-- Seasons List -->
            <div class="space-y-2">
              <h4 class="text-sm font-semibold text-gray-300 mb-2">Episodes by Season</h4>
              ${seasonsHtml}
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-between pt-4 mt-4 border-t border-gray-600">
              <button onclick="deleteSeries('${s.folder_name}', '${s.display_name}')" class="text-red-400 hover:text-red-300 text-sm">
                Delete Series
              </button>
              <button onclick="toggleSeriesCard('${s.folder_name}')" class="text-gray-400 hover:text-white text-sm">
                Close
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Add create new series card
    html += renderCreateSeriesCard();

    container.innerHTML = html;
    initCreateSeriesCard();

    // Re-init dropzone if a card is expanded
    if (expandedSeriesCard) {
      setTimeout(() => initSeriesDropzone(expandedSeriesCard), 100);
    }
  }

  function renderCreateSeriesCard() {
    const isExpanded = expandedSeriesCard === '__new__';
    return `
      <div class="create-series-card rounded-lg p-4 ${isExpanded ? 'expanded' : ''}" data-series-id="__new__" onclick="toggleSeriesCard('__new__', event)">
        <!-- Collapsed View -->
        <div class="card-header text-center">
          <span class="text-3xl text-gray-500">‚ûï</span>
          <p class="text-gray-400 mt-1">Create New Series</p>
        </div>

        <!-- Expanded Create Form -->
        <div class="card-form" onclick="event.stopPropagation()">
          <form id="create-series-form" action="/series/add" method="POST" class="space-y-3">
            <div>
              <label class="block text-xs mb-1 text-gray-400">Series Name</label>
              <input type="text" name="name" id="new-series-name" placeholder="e.g. Los Simuladores"
                     class="w-full bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 focus:border-green-500 text-sm" required>
            </div>
            <div class="flex items-center gap-3">
              <button type="submit" class="bg-green-500 hover:bg-green-600 text-black font-bold px-4 py-1.5 rounded text-sm">
                Create Series
              </button>
              <button type="button" onclick="toggleSeriesCard('__new__')" class="text-gray-400 hover:text-white text-sm">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    `;
  }

  function initCreateSeriesCard() {
    const form = document.getElementById('create-series-form');
    if (form && !form.dataset.initialized) {
      form.dataset.initialized = 'true';
      // Form submits via POST to /series/add which redirects back
    }
  }

  async function loadSeries() {
    try {
      const res = await fetch('/api/series');
      const data = await res.json();

      if (!data.ok) {
        seriesData = [];
      } else {
        seriesData = data.series || [];
      }

      document.getElementById('series-count').textContent = seriesData.length;
      renderSeriesCards();
    } catch (e) {
      console.error(e);
      seriesData = [];
      renderSeriesCards();
    }
  }

  // ============================================
  // MOVIES
  // ============================================
  const moviesUploader = setupUploader({
    dropzoneId: 'movies-dropzone',
    fileInputId: 'movies-file-input',
    fileListId: 'movies-file-list',
    fileItemsId: 'movies-file-items',
    uploadBtnId: 'movies-upload-btn',
    statusId: 'movies-upload-status',
    uploadUrl: '/upload/movies',
    existingIdsUrl: '/api/movies',
    onComplete: () => { loadMovies(); moviesUploader.refreshExistingIds(); }
  });

  async function loadMovies() {
    try {
      const res = await fetch('/api/movies');
      const data = await res.json();
      const container = document.getElementById('movies-list');

      if (!data.ok || !data.movies || data.movies.length === 0) {
        container.innerHTML = '<div class="text-gray-500 italic text-sm col-span-3">No movies yet</div>';
        document.getElementById('movies-count').textContent = '0';
        return;
      }

      document.getElementById('movies-count').textContent = data.movies.length;
      container.innerHTML = data.movies.map(m => `
        <div class="content-card rounded-lg p-3">
          <div class="flex gap-2 mb-2">
            <img src="/thumbnails/${m.video_id}.jpg" onerror="this.src='/thumbnails/default_thumbnail.png'"
                 class="w-14 h-14 object-cover rounded border border-gray-600">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-xs truncate text-white">${m.title}</h4>
              <p class="text-xs text-gray-400">${formatDuration(m.duration)}</p>
            </div>
          </div>
          <div class="flex gap-2">
            <a href="/edit/${m.video_id}" class="flex-1 text-center text-xs bg-gray-600 hover:bg-gray-700 text-white py-1 rounded">Edit</a>
            <button onclick="deleteMovie('${m.video_id}')" class="flex-1 text-center text-xs bg-red-600 hover:bg-red-700 text-white py-1 rounded">Delete</button>
          </div>
        </div>
      `).join('');
    } catch (e) { console.error(e); }
  }

  async function deleteMovie(videoId) {
    if (!confirm('Delete this movie?')) return;
    await fetch(`/api/movies/${videoId}`, { method: 'DELETE' });
    loadMovies();
  }

  // ============================================
  // COMMERCIALS
  // ============================================
  const commercialsUploader = setupUploader({
    dropzoneId: 'commercials-dropzone',
    fileInputId: 'commercials-file-input',
    fileListId: 'commercials-file-list',
    fileItemsId: 'commercials-file-items',
    uploadBtnId: 'commercials-upload-btn',
    statusId: 'commercials-upload-status',
    uploadUrl: '/upload/commercials',
    existingIdsUrl: '/api/commercials',
    onComplete: () => { loadCommercials(); commercialsUploader.refreshExistingIds(); }
  });

  async function loadCommercials() {
    try {
      const res = await fetch('/api/commercials');
      const data = await res.json();
      const container = document.getElementById('commercials-list');

      if (!data.ok || !data.commercials || data.commercials.length === 0) {
        container.innerHTML = '<div class="text-gray-500 italic text-sm col-span-3">No commercials yet</div>';
        document.getElementById('commercials-count').textContent = '0';
        return;
      }

      document.getElementById('commercials-count').textContent = data.commercials.length;
      container.innerHTML = data.commercials.map(c => `
        <div class="content-card rounded-lg p-3">
          <div class="flex gap-2 mb-2">
            <img src="/thumbnails/${c.video_id}.jpg" onerror="this.src='/thumbnails/default_thumbnail.png'"
                 class="w-14 h-14 object-cover rounded border border-gray-600">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-xs truncate text-white">${c.title}</h4>
              <p class="text-xs text-gray-400">${formatDuration(c.duration)}</p>
            </div>
          </div>
          <div class="flex gap-2">
            <a href="/edit/${c.video_id}" class="flex-1 text-center text-xs bg-gray-600 hover:bg-gray-700 text-white py-1 rounded">Edit</a>
            <button onclick="deleteCommercial('${c.video_id}')" class="flex-1 text-center text-xs bg-red-600 hover:bg-red-700 text-white py-1 rounded">Delete</button>
          </div>
        </div>
      `).join('');
    } catch (e) { console.error(e); }
  }

  async function deleteCommercial(videoId) {
    if (!confirm('Delete this commercial?')) return;
    await fetch(`/api/commercials/${videoId}`, { method: 'DELETE' });
    loadCommercials();
  }

  // ============================================
  // VHS TAPES
  // ============================================
  let currentInsertedTapeUid = null;

  async function loadVhsVideos() {
    try {
      const res = await fetch('/api/vcr/videos');
      const data = await res.json();
      if (data.ok) {
        const select = document.getElementById('register-video');
        select.innerHTML = '<option value="">-- Select video --</option>' +
          (data.videos || []).map(v => `<option value="${v.video_id}">${v.title} (${formatDuration(v.duration)})</option>`).join('');
      }
    } catch (e) { console.error(e); }
  }

  async function loadVhsTapes() {
    try {
      const res = await fetch('/api/vcr/tapes');
      const data = await res.json();
      const container = document.getElementById('vhs-list');

      if (!data.ok || !data.tapes || data.tapes.length === 0) {
        container.innerHTML = '<div class="text-gray-500 italic text-sm">No tapes registered</div>';
        document.getElementById('vhs-count').textContent = '0';
        return;
      }

      document.getElementById('vhs-count').textContent = data.tapes.length;
      container.innerHTML = data.tapes.map(tape => {
        const isInserted = tape.uid === currentInsertedTapeUid;
        return `
          <div class="content-card rounded-lg p-3 flex items-center gap-3 ${isInserted ? 'tape-inserted' : ''}" data-tape-uid="${tape.uid}">
            <span class="text-2xl">üìº</span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <h4 class="font-bold text-sm text-white truncate">${tape.title || tape.video_id}</h4>
                ${isInserted ? '<span class="inserted-badge bg-green-500 text-black text-[10px] px-1.5 py-0.5 rounded font-bold">INSERTED</span>' : ''}
              </div>
              <p class="text-xs text-gray-400 truncate">Video: ${tape.video_title || tape.video_id}</p>
              <p class="text-xs text-gray-500">Position: ${formatDuration(tape.position_sec || 0)}</p>
            </div>
            <div class="flex flex-col gap-1">
              <button onclick="reassignTape('${tape.uid}')" class="text-yellow-400 hover:underline text-xs">Reassign</button>
              <button onclick="deleteTape('${tape.uid}')" class="text-red-400 hover:underline text-xs">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    } catch (e) { console.error(e); }
  }

  async function updateReaderStatus() {
    try {
      const res = await fetch('/api/vcr/state');
      const data = await res.json();

      const statusEl = document.getElementById('reader-status');
      const iconEl = document.getElementById('reader-icon');
      const textEl = document.getElementById('reader-text');
      const detailEl = document.getElementById('reader-detail');
      const registerSection = document.getElementById('register-tape-section');

      if (!data.ok) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-red-600 bg-red-900/30';
        iconEl.textContent = '‚ùå';
        textEl.textContent = 'Error';
        detailEl.textContent = data.error || '';
        registerSection.classList.add('hidden');
        currentInsertedTapeUid = null;
        return;
      }

      if (!data.reader_attached) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-gray-600 bg-gray-900/50';
        iconEl.textContent = 'üîå';
        textEl.textContent = 'NFC Reader Not Connected';
        detailEl.textContent = 'Connect USB NFC reader';
        registerSection.classList.add('hidden');
        currentInsertedTapeUid = null;
      } else if (data.tape_inserted) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-green-600 bg-green-900/30';
        iconEl.textContent = '‚ñ∂Ô∏è';
        textEl.textContent = 'Playing: ' + (data.title || data.video_id);
        detailEl.textContent = 'Tape inserted';
        registerSection.classList.add('hidden');
        currentInsertedTapeUid = data.tape_uid || null;
        // Update tape list to show inserted badge
        document.querySelectorAll('[data-tape-uid]').forEach(el => {
          const isThis = el.dataset.tapeUid === currentInsertedTapeUid;
          el.classList.toggle('tape-inserted', isThis);
          const badge = el.querySelector('.inserted-badge');
          if (isThis && !badge) {
            el.querySelector('h4').insertAdjacentHTML('afterend', '<span class="inserted-badge bg-green-500 text-black text-[10px] px-1.5 py-0.5 rounded font-bold ml-2">INSERTED</span>');
          } else if (!isThis && badge) {
            badge.remove();
          }
        });
      } else if (data.unknown_tape_uid) {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-yellow-600 bg-yellow-900/30';
        iconEl.textContent = '‚ùì';
        textEl.textContent = 'Unregistered Tape';
        detailEl.textContent = 'Register it below';
        registerSection.classList.remove('hidden');
        document.getElementById('detected-uid').textContent = data.unknown_tape_uid;
        document.getElementById('register-uid').value = data.unknown_tape_uid;
        currentInsertedTapeUid = null;
      } else {
        statusEl.className = 'mb-4 p-3 rounded-lg border-2 border-blue-600 bg-blue-900/30';
        iconEl.textContent = 'üì°';
        textEl.textContent = 'Ready';
        detailEl.textContent = 'Place tape on reader';
        registerSection.classList.add('hidden');
        currentInsertedTapeUid = null;
      }
    } catch (e) { console.error(e); }
  }

  document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const uid = document.getElementById('register-uid').value;
    const videoId = document.getElementById('register-video').value;
    const title = document.getElementById('register-title').value;

    if (!uid || !videoId) { alert('Select a video'); return; }

    const res = await fetch('/api/vcr/tapes/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, video_id: videoId, title: title || null })
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('register-form').reset();
      loadVhsTapes();
      updateReaderStatus();
    } else {
      alert('Error: ' + (data.error || 'Unknown'));
    }
  });

  async function deleteTape(uid) {
    if (!confirm('Delete this tape?')) return;
    await fetch(`/api/vcr/tapes/${encodeURIComponent(uid)}`, { method: 'DELETE' });
    loadVhsTapes();
  }

  async function reassignTape(uid) {
    const videoId = prompt('Enter new video ID (or leave empty to cancel):');
    if (!videoId) return;
    // For now, delete and re-register
    await fetch(`/api/vcr/tapes/${encodeURIComponent(uid)}`, { method: 'DELETE' });
    await fetch('/api/vcr/tapes/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, video_id: videoId })
    });
    loadVhsTapes();
  }

  // ============================================
  // INIT
  // ============================================
  document.addEventListener('DOMContentLoaded', () => {
    loadSeries();
    loadMovies();
    loadCommercials();
    loadVhsVideos();
    loadVhsTapes();
    updateReaderStatus();

    setInterval(updateReaderStatus, 2000);
    setInterval(loadVhsTapes, 10000);
  });
{% endblock %}
